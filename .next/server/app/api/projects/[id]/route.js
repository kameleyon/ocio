"use strict";(()=>{var e={};e.id=361,e.ids=[361],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},79130:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>j,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>q});var i={};r.r(i),r.d(i,{DELETE:()=>f,GET:()=>p,PUT:()=>h});var o=r(95419),s=r(69108),a=r(99678),n=r(78070),d=r(81664),u=r(32455),c=r(86382),l=r(16758);let p=(0,c.b)((0,l.er)(async(e,{params:t})=>{let r=(0,u.cookies)(),i=(0,d.e)(r),{data:{session:o}}=await i.auth.getSession();if(!o)throw c.M.unauthorized("Authentication required");let s=t.id,{data:a,error:l}=await i.from("projects").select("*").eq("id",s).eq("user_id",o.user.id).single();if(l){if("PGRST116"===l.code)throw c.M.notFound("Project not found");throw c.M.internal("Error fetching project")}return await i.rpc("add_audit_log",{p_user_id:o.user.id,p_action:"view",p_entity_type:"project",p_entity_id:s,p_details:{},p_ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),n.Z.json(a)})),h=(0,c.b)((0,l.er)(async(e,{params:t})=>{let r=(0,u.cookies)(),i=(0,d.e)(r),{data:{session:o}}=await i.auth.getSession();if(!o)throw c.M.unauthorized("Authentication required");let s=t.id,{data:a,error:l}=await i.from("projects").select("id, user_id, status").eq("id",s).eq("user_id",o.user.id).single();if(l){if("PGRST116"===l.code)throw c.M.notFound("Project not found");throw c.M.internal("Error fetching project")}if("generating"===a.status||"pending"===a.status)throw c.M.badRequest("Cannot update a project that is currently generating");let p=await e.json(),h=["name","description","tech_stack"],f=Object.keys(p).filter(e=>h.includes(e)).reduce((e,t)=>(e[t]=p[t],e),{});if(0===Object.keys(f).length)throw c.M.badRequest("No valid fields to update");let{data:g,error:w}=await i.from("projects").update(f).eq("id",s).select().single();if(w)throw c.M.internal("Error updating project");return await i.rpc("add_audit_log",{p_user_id:o.user.id,p_action:"update",p_entity_type:"project",p_entity_id:s,p_details:{updates:f},p_ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),n.Z.json(g)})),f=(0,c.b)((0,l.er)(async(e,{params:t})=>{let r=(0,u.cookies)(),i=(0,d.e)(r),{data:{session:o}}=await i.auth.getSession();if(!o)throw c.M.unauthorized("Authentication required");let s=t.id,{data:a,error:l}=await i.from("projects").select("id, user_id, name").eq("id",s).eq("user_id",o.user.id).single();if(l){if("PGRST116"===l.code)throw c.M.notFound("Project not found");throw c.M.internal("Error fetching project")}let p={id:a.id,name:a.name},{data:h}=await i.storage.from("project-files").list(`project-zips/${s}`);if(h&&h.length>0){let e=h.map(e=>`project-zips/${s}/${e.name}`);await i.storage.from("project-files").remove(e)}let{error:f}=await i.from("projects").delete().eq("id",s);if(f)throw c.M.internal("Error deleting project");return await i.rpc("add_audit_log",{p_user_id:o.user.id,p_action:"delete",p_entity_type:"project",p_entity_id:s,p_details:p,p_ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),n.Z.json({success:!0})})),g=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/projects/[id]/route",pathname:"/api/projects/[id]",filename:"route",bundlePath:"app/api/projects/[id]/route"},resolvedPagePath:"c:\\Users\\Administrator\\ocio\\app\\api\\projects\\[id]\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:w,staticGenerationAsyncStorage:m,serverHooks:_,headerHooks:y,staticGenerationBailout:q}=g,j="/api/projects/[id]/route";function x(){return(0,a.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:m})}},81664:(e,t,r)=>{r.d(t,{K:()=>a,e:()=>s});var i=r(46874),o=r(32455);function s(e){return(0,i.lx)(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(t,r,i){e.set({name:t,value:r,...i})},remove(t,r){e.set({name:t,value:"",...r})}}})}function a(){return s((0,o.cookies)())}},86382:(e,t,r)=>{r.d(t,{M:()=>o,b:()=>s});var i=r(78070);class o extends Error{constructor(e,t=500,r){super(e),this.name="ApiError",this.statusCode=t,this.details=r}static badRequest(e="Bad Request",t){return new o(e,400,t)}static unauthorized(e="Unauthorized",t){return new o(e,401,t)}static forbidden(e="Forbidden",t){return new o(e,403,t)}static notFound(e="Not Found",t){return new o(e,404,t)}static methodNotAllowed(e="Method Not Allowed",t){return new o(e,405,t)}static tooManyRequests(e="Too Many Requests",t){return new o(e,429,t)}static internal(e="Internal Server Error",t){return new o(e,500,t)}static fromError(e){return e?.code==="PGRST116"?o.notFound("Resource not found"):e?.code==="23505"?o.badRequest("Duplicate entry",{code:e.code}):e?.code?.startsWith("22")?o.badRequest("Invalid input syntax",{code:e.code}):e?.code?.startsWith("23")?o.badRequest("Constraint violation",{code:e.code}):e?.status===401?o.unauthorized(e.message||"Authentication failed"):e?.status===403?o.forbidden(e.message||"Permission denied"):o.internal()}toResponse(){let e={error:{message:this.message,statusCode:this.statusCode,...this.details&&{details:this.details}}};return i.Z.json(e,{status:this.statusCode})}}function s(e){return async(...t)=>{try{return await e(...t)}catch(e){if(console.error("API Error:",e),e instanceof o)return e.toResponse();return o.fromError(e).toResponse()}}}},16758:(e,t,r)=>{r.d(t,{er:()=>c});var i=r(81664),o=r(32455),s=r(86382);let a={anonymous:{limit:30,window:60},free:{limit:60,window:60},pro:{limit:300,window:60},enterprise:{limit:1e3,window:60}},n={};async function d(e){let t=(0,o.cookies)(),r=(0,i.e)(t);try{let{data:{session:e}}=await r.auth.getSession();if(e?.user){let{data:t}=await r.from("profiles").select("subscription_tier").eq("id",e.user.id).single();return{...a[t?.subscription_tier||"free"],useUserIdWhenAvailable:!0}}}catch(e){console.error("Error getting rate limit config:",e)}return a.anonymous}async function u(e,t){let r;let a={...await d(e),...t};if(a.keyGenerator)r=a.keyGenerator(e);else if(r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"127.0.0.1",a.useUserIdWhenAvailable){let e=(0,o.cookies)(),t=(0,i.e)(e);try{let{data:{session:e}}=await t.auth.getSession();e?.user&&(r=`user_${e.user.id}`)}catch(e){console.error("Error getting user ID for rate limiting:",e)}}n[r]||(n[r]=[]);let u=Date.now(),c=1e3*a.window;if(n[r]=n[r].filter(e=>u-e<c),n[r].length>=a.limit){let e=Math.min(...n[r])+c,t=Math.ceil((e-u)/1e3),i=new Headers;throw i.set("X-RateLimit-Limit",a.limit.toString()),i.set("X-RateLimit-Remaining","0"),i.set("X-RateLimit-Reset",Math.ceil(e/1e3).toString()),i.set("Retry-After",t.toString()),s.M.tooManyRequests(a.message||`Rate limit exceeded. Try again in ${t} seconds.`,{meta:{retryAfter:t}})}n[r].push(u);let l=new Headers;return l.set("X-RateLimit-Limit",a.limit.toString()),l.set("X-RateLimit-Remaining",(a.limit-n[r].length).toString()),l}function c(e,t){return async(...r)=>{let i=r[0];try{let o=await u(i,t),s=await e(...r);return o.forEach((e,t)=>{s.headers.set(t,e)}),s}catch(e){if(e instanceof s.M&&429===e.statusCode)return e.toResponse();throw e}}}setInterval(()=>{let e=Date.now();Object.keys(n).forEach(t=>{n[t]=n[t].filter(t=>e-t<36e5),0===n[t].length&&delete n[t]})},3e5)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[638,246,455,874],()=>r(79130));module.exports=i})();