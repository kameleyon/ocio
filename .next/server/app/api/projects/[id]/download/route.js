"use strict";(()=>{var e={};e.id=419,e.ids=[419],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},26182:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>_,patchFetch:()=>q,requestAsyncStorage:()=>g,routeModule:()=>f,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>j});var o={};r.r(o),r.d(o,{GET:()=>w});var a=r(95419),i=r(69108),n=r(99678),s=r(78070),c=r(81664),d=r(42094),l=r(86382),u=r(16758),p=r(20967);let w=(0,l.b)((0,u.er)(async(e,{params:t})=>{let r=(0,c.K)(),{data:{session:o}}=await r.auth.getSession();if(!o)throw l.M.unauthorized("Authentication required");let a=t.id,{data:i,error:n}=await r.from("projects").select("id, user_id, name, description, status, tech_stack, structure, files, download_url").eq("id",a).eq("user_id",o.user.id).single();if(n){if("PGRST116"===n.code)throw l.M.notFound("Project not found");throw l.M.internal("Error fetching project")}if(i.download_url)return await r.rpc("add_audit_log",{p_user_id:o.user.id,p_action:"download",p_entity_type:"project",p_entity_id:a,p_details:{project_name:i.name},p_ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),s.Z.redirect(i.download_url);if("completed"!==i.status)throw l.M.badRequest("Project is not ready for download. Current status: "+i.status);try{let t=new p.Y,n=await t.getProjectFiles(a);if(!n||0===n.length)throw l.M.internal("No files found for project");let c=await (0,d.d6)(i.name,n),u=Date.now(),w=i.name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),f=`project-zips/${a}/${u}-${w}.zip`,{error:g}=await r.storage.from("project-files").upload(f,c,{contentType:"application/zip",upsert:!0});if(g)throw Error(`Error uploading zip file: ${g.message}`);let{data:h}=r.storage.from("project-files").getPublicUrl(f);return await r.from("projects").update({download_url:h.publicUrl}).eq("id",a),await r.rpc("add_audit_log",{p_user_id:o.user.id,p_action:"download",p_entity_type:"project",p_entity_id:a,p_details:{project_name:i.name},p_ip_address:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),s.Z.redirect(h.publicUrl)}catch(e){throw console.error("Error generating zip file:",e),l.M.internal("Failed to generate download file")}},{limit:10,window:60,message:"You can only download 10 projects per minute. Please try again later."})),f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/projects/[id]/download/route",pathname:"/api/projects/[id]/download",filename:"route",bundlePath:"app/api/projects/[id]/download/route"},resolvedPagePath:"c:\\Users\\Administrator\\ocio\\app\\api\\projects\\[id]\\download\\route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:m,headerHooks:y,staticGenerationBailout:j}=f,_="/api/projects/[id]/download/route";function q(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},20967:(e,t,r)=>{r.d(t,{Y:()=>i,r:()=>n});let o=(0,r(46874).AY)("https://cfovctpyutyvyqzvypwx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmb3ZjdHB5dXR5dnlxenZ5cHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MTk0MDIsImV4cCI6MjA2MDQ5NTQwMn0.J-c-JGblGgP4zi5ceTORCq8MYbdfcbtP-Ml8a8s4oRM");var a=r(42094);class i{async createProject(e,t){try{let r=await (0,a.lv)(t),{data:i,error:n}=await o.from("projects").insert([{user_id:e,name:r,description:t,prompt:t,status:"pending",tech_stack:{}}]).select().single();if(n)throw n;return this.generateFullProject(i.id,t),i}catch(e){return console.error("Error creating project:",e),null}}async generateFullProject(e,t){try{await o.from("projects").update({status:"generating"}).eq("id",e);let r=await (0,a.bh)(t);await o.from("projects").update({name:r.name,description:r.description,tech_stack:r.techStack,structure:r.structure}).eq("id",e);let i=await (0,a.iq)(t,r),n=await (0,a.d6)(r.name,i);console.log(`Generated ${i.length} files for project ${r.name}`);let s=Date.now(),c=r.name.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,""),d=`project-zips/${e}/${s}-${c}.zip`,{error:l}=await o.storage.from("project-files").upload(d,n,{contentType:"application/zip",upsert:!0});if(l)throw l;let{data:u}=o.storage.from("project-files").getPublicUrl(d);await o.from("projects").update({status:"completed",download_url:u.publicUrl,files:i.map(e=>e.path)}).eq("id",e)}catch(t){console.error("Error generating full project:",t),await o.from("projects").update({status:"failed"}).eq("id",e)}}async getUserProjects(){try{let{data:e}=await o.auth.getSession();if(!e.session)throw Error("Authentication required");let t=e.session.user.id,{data:r,error:a}=await o.from("projects").select("*").eq("user_id",t).order("created_at",{ascending:!1});if(a)throw a;return r||[]}catch(e){return console.error("Error fetching projects:",e),[]}}static async getProjectsByUserId(e){try{let{data:t,error:r}=await o.from("projects").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(r)throw r;return t||[]}catch(e){return console.error("Error fetching projects by user ID:",e),[]}}async getProjectById(e){try{let{data:t,error:r}=await o.from("projects").select("*").eq("id",e).single();if(r)throw r;return t}catch(e){return console.error("Error fetching project:",e),null}}async downloadProject(e){try{let t=await this.getProjectById(e);if(!t||!t.download_url)throw Error("Project or download URL not found");return window.open(t.download_url,"_blank"),!0}catch(e){return console.error("Error downloading project:",e),!1}}async deleteProject(e){try{let t=`project-zips/${e}`,{data:r}=await o.storage.from("project-files").list(t);if(r&&r.length>0){let e=r.map(e=>`${t}/${e.name}`);await o.storage.from("project-files").remove(e)}let{error:a}=await o.from("projects").delete().eq("id",e);if(a)throw a;return!0}catch(e){return console.error("Error deleting project:",e),!1}}async regenerateProject(e){try{let t=await this.getProjectById(e);if(!t)throw Error("Project not found");return await o.from("projects").update({status:"generating"}).eq("id",e),this.generateFullProject(e,t.prompt),!0}catch(e){return console.error("Error regenerating project:",e),!1}}async getProjectFiles(e){try{let t=await this.getProjectById(e);if(!t)throw Error("Project not found");if("completed"!==t.status)return[];return(0,a.eU)({name:t.name,description:t.description,techStack:t.tech_stack,files:t.files||[],structure:t.structure||[]})}catch(e){return console.error("Error getting project files:",e),[]}}async incrementUserGenerationCount(e){try{let{error:t}=await o.rpc("increment_generation_count",{user_id:e});if(t)throw t;return!0}catch(e){return console.error("Error incrementing generation count:",e),!1}}}async function n(e){return i.getProjectsByUserId(e)}},81664:(e,t,r)=>{r.d(t,{K:()=>n,e:()=>i});var o=r(46874),a=r(32455);function i(e){return(0,o.lx)(process.env.SUPABASE_URL,process.env.SUPABASE_ANON_KEY,{cookies:{get:t=>e.get(t)?.value,set(t,r,o){e.set({name:t,value:r,...o})},remove(t,r){e.set({name:t,value:"",...r})}}})}function n(){return i((0,a.cookies)())}},86382:(e,t,r)=>{r.d(t,{M:()=>a,b:()=>i});var o=r(78070);class a extends Error{constructor(e,t=500,r){super(e),this.name="ApiError",this.statusCode=t,this.details=r}static badRequest(e="Bad Request",t){return new a(e,400,t)}static unauthorized(e="Unauthorized",t){return new a(e,401,t)}static forbidden(e="Forbidden",t){return new a(e,403,t)}static notFound(e="Not Found",t){return new a(e,404,t)}static methodNotAllowed(e="Method Not Allowed",t){return new a(e,405,t)}static tooManyRequests(e="Too Many Requests",t){return new a(e,429,t)}static internal(e="Internal Server Error",t){return new a(e,500,t)}static fromError(e){return e?.code==="PGRST116"?a.notFound("Resource not found"):e?.code==="23505"?a.badRequest("Duplicate entry",{code:e.code}):e?.code?.startsWith("22")?a.badRequest("Invalid input syntax",{code:e.code}):e?.code?.startsWith("23")?a.badRequest("Constraint violation",{code:e.code}):e?.status===401?a.unauthorized(e.message||"Authentication failed"):e?.status===403?a.forbidden(e.message||"Permission denied"):a.internal()}toResponse(){let e={error:{message:this.message,statusCode:this.statusCode,...this.details&&{details:this.details}}};return o.Z.json(e,{status:this.statusCode})}}function i(e){return async(...t)=>{try{return await e(...t)}catch(e){if(console.error("API Error:",e),e instanceof a)return e.toResponse();return a.fromError(e).toResponse()}}}},16758:(e,t,r)=>{r.d(t,{er:()=>l});var o=r(81664),a=r(32455),i=r(86382);let n={anonymous:{limit:30,window:60},free:{limit:60,window:60},pro:{limit:300,window:60},enterprise:{limit:1e3,window:60}},s={};async function c(e){let t=(0,a.cookies)(),r=(0,o.e)(t);try{let{data:{session:e}}=await r.auth.getSession();if(e?.user){let{data:t}=await r.from("profiles").select("subscription_tier").eq("id",e.user.id).single();return{...n[t?.subscription_tier||"free"],useUserIdWhenAvailable:!0}}}catch(e){console.error("Error getting rate limit config:",e)}return n.anonymous}async function d(e,t){let r;let n={...await c(e),...t};if(n.keyGenerator)r=n.keyGenerator(e);else if(r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"127.0.0.1",n.useUserIdWhenAvailable){let e=(0,a.cookies)(),t=(0,o.e)(e);try{let{data:{session:e}}=await t.auth.getSession();e?.user&&(r=`user_${e.user.id}`)}catch(e){console.error("Error getting user ID for rate limiting:",e)}}s[r]||(s[r]=[]);let d=Date.now(),l=1e3*n.window;if(s[r]=s[r].filter(e=>d-e<l),s[r].length>=n.limit){let e=Math.min(...s[r])+l,t=Math.ceil((e-d)/1e3),o=new Headers;throw o.set("X-RateLimit-Limit",n.limit.toString()),o.set("X-RateLimit-Remaining","0"),o.set("X-RateLimit-Reset",Math.ceil(e/1e3).toString()),o.set("Retry-After",t.toString()),i.M.tooManyRequests(n.message||`Rate limit exceeded. Try again in ${t} seconds.`,{meta:{retryAfter:t}})}s[r].push(d);let u=new Headers;return u.set("X-RateLimit-Limit",n.limit.toString()),u.set("X-RateLimit-Remaining",(n.limit-s[r].length).toString()),u}function l(e,t){return async(...r)=>{let o=r[0];try{let a=await d(o,t),i=await e(...r);return a.forEach((e,t)=>{i.headers.set(t,e)}),i}catch(e){if(e instanceof i.M&&429===e.statusCode)return e.toResponse();throw e}}}setInterval(()=>{let e=Date.now();Object.keys(s).forEach(t=>{s[t]=s[t].filter(t=>e-t<36e5),0===s[t].length&&delete s[t]})},3e5)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[638,246,455,874,847,94],()=>r(26182));module.exports=o})();