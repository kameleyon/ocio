"use strict";(()=>{var e={};e.id=131,e.ids=[131],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},77990:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>b,originalPathname:()=>E,patchFetch:()=>S,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>m});var s={};r.r(s),r.d(s,{POST:()=>_});var o=r(95419),a=r(69108),i=r(99678),n=r(78070),d=r(86323),c=r(42094);class u{static async handleProjectCreation(e,t){try{await e.from("projects").update({status:"generating"}).eq("id",t.id);let r=await (0,c.bh)(t.prompt);await e.from("projects").update({name:r.name,description:r.description,tech_stack:r.techStack,structure:r.structure,status:"completed",download_url:`/api/projects/${t.id}/download`}).eq("id",t.id),await e.rpc("add_audit_log",{p_user_id:t.user_id,p_action:"generate",p_entity_type:"project",p_entity_id:t.id,p_details:{success:!0},p_ip_address:null}),await p(e,t.user_id,{type:"project_completed",title:"Project Generated Successfully",message:`Your project "${r.name}" has been successfully generated and is ready for download.`,linkUrl:`/projects?id=${t.id}`})}catch(r){console.error("Error generating project:",r),await e.from("projects").update({status:"failed",tech_stack:{error:"Failed to generate project details"}}).eq("id",t.id),await e.rpc("add_audit_log",{p_user_id:t.user_id,p_action:"generate",p_entity_type:"project",p_entity_id:t.id,p_details:{success:!1,error:r.message},p_ip_address:null}),await p(e,t.user_id,{type:"project_failed",title:"Project Generation Failed",message:"There was an error generating your project. Please try again or contact support if the issue persists.",linkUrl:`/build?projectId=${t.id}`})}}static async handleProjectStatusChange(e,t,r){let{status:s,id:o,user_id:a}=t;if("completed"===s&&"completed"!==r.status)try{let r={name:t.name,description:t.description,techStack:t.tech_stack},s=[{path:"README.md",content:`# ${t.name}

${t.description}

## Tech Stack

${JSON.stringify(t.tech_stack,null,2)}`}],a=await (0,c.d6)(r.name,s);a&&await e.from("projects").update({download_url:a}).eq("id",o)}catch(e){console.error("Error generating ZIP file:",e)}}static async handleProfileCreation(e,t){try{await p(e,t.id,{type:"welcome",title:"Welcome to OptimusCode.io!",message:"Get started by creating your first project. Just describe what you want to build, and we'll generate the code!",linkUrl:"/build"}),await e.rpc("add_audit_log",{p_user_id:t.id,p_action:"create",p_entity_type:"profile",p_entity_id:t.id,p_details:{},p_ip_address:null})}catch(e){console.error("Error handling profile creation:",e)}}static async handleSubscriptionChange(e,t,r){try{let{id:s,subscription_tier:o}=t,a=r.subscription_tier||"free";("free"===a&&["pro","enterprise"].includes(o)||"pro"===a&&"enterprise"===o)&&await p(e,s,{type:"subscription_upgraded",title:`Upgraded to ${o.charAt(0).toUpperCase()}${o.slice(1)}`,message:`Thank you for upgrading to the ${o} tier! You now have access to additional features and higher generation limits.`,linkUrl:"/build"}),await e.rpc("add_audit_log",{p_user_id:s,p_action:"update",p_entity_type:"subscription",p_entity_id:s,p_details:{old_tier:a,new_tier:o},p_ip_address:null})}catch(e){console.error("Error handling subscription change:",e)}}}async function p(e,t,r){try{return console.log(`Sending notification to user ${t}: ${r.title}`),!0}catch(e){return console.error("Error sending notification:",e),!1}}var l=r(86382);let h=process.env.WEBHOOK_SECRET;async function _(e){try{!function(e){if(!h)return console.warn("WEBHOOK_SECRET is not set");if(!e.headers.get("x-webhook-signature"))throw l.M.unauthorized("Missing webhook signature")}(e);let{type:t,table:r,record:s,old_record:o}=await e.json(),a=function(){let e=process.env.SUPABASE_URL,t=process.env.SUPABASE_SERVICE_KEY||process.env.SUPABASE_ANON_KEY;if(!e)throw Error("SUPABASE_URL is required");if(!t)throw Error("SUPABASE_SERVICE_KEY or SUPABASE_ANON_KEY is required");return(0,d.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}();switch(`${t}:${r}`){case"INSERT:projects":await u.handleProjectCreation(a,s);break;case"UPDATE:projects":o.status!==s.status&&await u.handleProjectStatusChange(a,s,o);break;case"INSERT:profiles":await u.handleProfileCreation(a,s);break;case"UPDATE:profiles":o.subscription_tier!==s.subscription_tier&&await u.handleSubscriptionChange(a,s,o)}return n.Z.json({success:!0})}catch(e){if(console.error("Error processing webhook:",e),e instanceof l.M)return e.toResponse();return n.Z.json({error:"Error processing webhook"},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webhooks/supabase/route",pathname:"/api/webhooks/supabase",filename:"route",bundlePath:"app/api/webhooks/supabase/route"},resolvedPagePath:"c:\\Users\\Administrator\\ocio\\app\\api\\webhooks\\supabase\\route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:y,headerHooks:b,staticGenerationBailout:m}=g,E="/api/webhooks/supabase/route";function S(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:f})}},86382:(e,t,r)=>{r.d(t,{M:()=>o,b:()=>a});var s=r(78070);class o extends Error{constructor(e,t=500,r){super(e),this.name="ApiError",this.statusCode=t,this.details=r}static badRequest(e="Bad Request",t){return new o(e,400,t)}static unauthorized(e="Unauthorized",t){return new o(e,401,t)}static forbidden(e="Forbidden",t){return new o(e,403,t)}static notFound(e="Not Found",t){return new o(e,404,t)}static methodNotAllowed(e="Method Not Allowed",t){return new o(e,405,t)}static tooManyRequests(e="Too Many Requests",t){return new o(e,429,t)}static internal(e="Internal Server Error",t){return new o(e,500,t)}static fromError(e){return e?.code==="PGRST116"?o.notFound("Resource not found"):e?.code==="23505"?o.badRequest("Duplicate entry",{code:e.code}):e?.code?.startsWith("22")?o.badRequest("Invalid input syntax",{code:e.code}):e?.code?.startsWith("23")?o.badRequest("Constraint violation",{code:e.code}):e?.status===401?o.unauthorized(e.message||"Authentication failed"):e?.status===403?o.forbidden(e.message||"Permission denied"):o.internal()}toResponse(){let e={error:{message:this.message,statusCode:this.statusCode,...this.details&&{details:this.details}}};return s.Z.json(e,{status:this.statusCode})}}function a(e){return async(...t)=>{try{return await e(...t)}catch(e){if(console.error("API Error:",e),e instanceof o)return e.toResponse();return o.fromError(e).toResponse()}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,246,847,94],()=>r(77990));module.exports=s})();